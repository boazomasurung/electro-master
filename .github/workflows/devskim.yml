name: DevSkim

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  # Deploy to Boaz's Ubuntu laptop
  deploy-boaz:
    name: Deploy to Boaz (Ubuntu)
    runs-on: [self-hosted, laptop-boaz]
    
    steps:
    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'electro-master' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå Error: Folder electro-master tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "‚úÖ Found project at: $PROJECT_PATH"
        
    - name: System Info
      run: |
        echo "üñ•Ô∏è  OS: $(lsb_release -d | cut -f2)"
        echo "üê≥ Docker: $(docker --version)"
        echo "üì¶ Docker Compose: $(docker compose version)"
        
    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master
        git reset --hard origin/master
        echo "‚úÖ Code updated to latest version"
        
    - name: Stop existing containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose down || true
        echo "‚úÖ Containers stopped"
        
    - name: Cleanup old images
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker system prune -f
        docker image prune -a -f
        echo "‚úÖ Cleanup completed"
        
    - name: Create index.html if not exists
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        if [ ! -f "index.html" ]; then
          cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta http-equiv="refresh" content="0; url=/pages/login.php">
            <title>Redirecting...</title>
        </head>
        <body>
            <p>Redirecting to login page...</p>
            <a href="/pages/login.php">Click here if not redirected</a>
        </body>
        </html>
        EOF
          echo "‚úÖ Created index.html redirect file"
        else
          echo "‚ÑπÔ∏è  index.html already exists"
        fi
        
    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose build --no-cache
        docker compose up -d
        echo "‚úÖ Containers started"
        
    - name: Wait for services
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "‚è≥ Waiting 30 seconds for services to stabilize..."
        sleep 30
        docker compose ps
        
    - name: Health check
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üîç Testing application health..."
        max_attempts=30
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          echo "Attempt $((attempt+1))/$max_attempts"
          
          # Test login page
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/pages/login.php 2>&1 || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Application is healthy (HTTP 200)"
            exit 0
          fi
          
          echo "Got HTTP $response, retrying..."
          attempt=$((attempt+1))
          sleep 2
        done
        
        echo "‚ùå Health check failed"
        docker compose logs --tail=50
        exit 1
        
    - name: Deployment summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deployment SUCCESS on laptop-Boaz (Debian)"
          echo "üåê Application: http://localhost:8080"
          echo "üóÑÔ∏è  phpMyAdmin: http://localhost:8081"
        else
          echo "‚ùå Deployment FAILED on laptop-boaz (Debian)"
        fi

  # Deploy to Vermicide's Ubuntu laptop
  deploy-adib:
    name: Deploy to adib (Ubuntu)
    runs-on: [self-hosted, my-laptop, laptop-adib]
    
    steps:
    - name: Set project path
      run: |
        PROJECT_PATH=$(find /home -name 'electro-master' -type d 2>/dev/null | head -1)
        if [ -z "$PROJECT_PATH" ]; then
          echo "‚ùå Error: Folder electro-master tidak ditemukan"
          exit 1
        fi
        echo "PROJECT_PATH=$PROJECT_PATH" >> $GITHUB_ENV
        echo "‚úÖ Found project at: $PROJECT_PATH"
        
    - name: System Info
      run: |
        echo "üñ•Ô∏è  OS: $(lsb_release -d | cut -f2)"
        echo "üê≥ Docker: $(docker --version)"
        echo "üì¶ Docker Compose: $(docker compose version)"
        
    - name: Pull latest changes
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        git fetch origin master
        git reset --hard origin/master
        echo "‚úÖ Code updated to latest version"
        
    - name: Stop existing containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose down || true
        echo "‚úÖ Containers stopped"
        
    - name: Cleanup old images
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker system prune -f
        docker image prune -a -f
        echo "‚úÖ Cleanup completed"
        
    - name: Create index.html if not exists
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        if [ ! -f "index.html" ]; then
          cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta http-equiv="refresh" content="0; url=/pages/login.php">
            <title>Redirecting...</title>
        </head>
        <body>
            <p>Redirecting to login page...</p>
            <a href="/pages/login.php">Click here if not redirected</a>
        </body>
        </html>
        EOF
          echo "‚úÖ Created index.html redirect file"
        else
          echo "‚ÑπÔ∏è  index.html already exists"
        fi
        
    - name: Build and start containers
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        docker compose build --no-cache
        docker compose up -d
        echo "‚úÖ Containers started"
        
    - name: Wait for services
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "‚è≥ Waiting 30 seconds for services to stabilize..."
        sleep 30
        docker compose ps
        
    - name: Health check
      working-directory: ${{ env.PROJECT_PATH }}
      run: |
        echo "üîç Testing application health..."
        max_attempts=30
        attempt=0
        
        while [ $attempt -lt $max_attempts ]; do
          echo "Attempt $((attempt+1))/$max_attempts"
          
          # Test login page
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/pages/login.php 2>&1 || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Application is healthy (HTTP 200)"
            exit 0
          fi
          
          echo "Got HTTP $response, retrying..."
          attempt=$((attempt+1))
          sleep 2
        done
        
        echo "‚ùå Health check failed"
        docker compose logs --tail=50
        exit 1
        
    - name: Deployment summary
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "‚úÖ Deployment SUCCESS on my-laptop (Ubuntu)"
          echo "üåê Application: http://localhost:8080"
          echo "üóÑÔ∏è  phpMyAdmin: http://localhost:8081"
        else
          echo "‚ùå Deployment FAILED on my-laptop (Ubuntu)"
        fi